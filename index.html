<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>AR PLAY 3Dモデル（iPhone安定版）</title>

<!-- A-Frame + AR.js -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
    width: 100%;
    background: #000;
    touch-action: none; /* iPhone Safariの二本指ズーム防止 */
  }

  a-scene {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
  }

  #info {
    position: fixed;
    top: 10px; left: 10px;
    color: white;
    background: rgba(0,0,0,0.5);
    padding: 8px 12px;
    border-radius: 8px;
    font-family: sans-serif;
    z-index: 999;
  }

  #reset {
    position: fixed;
    bottom: 50px; left: 10px;
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    color: white;
    cursor: pointer;
    background: #28a745;
    z-index: 1000;
  }
</style>
</head>
<body>

<div id="info">指でモデルを操作できます</div>
<button id="reset">リセット</button>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="sourceType: webcam; debugUIEnabled: false;"
  renderer="antialias: true; alpha: true;"
  device-orientation-permission-ui="enabled: true"
>
  <!-- 光源 -->
  <a-light type="ambient" intensity="1.0"></a-light>
  <a-light type="directional" intensity="0.9" position="1 2 1"></a-light>
  <a-light type="point" intensity="0.6" position="-2 3 3"></a-light>

  <!-- モデル -->
  <a-entity id="model"
    gltf-model="./gyu.glb"
    position="0 0 -12"
    scale="0.5 0.5 0.5"
    rotation="0 0 0"
    visible="true">
  </a-entity>

  <a-camera id="camera"></a-camera>
</a-scene>

<script>
const model = document.getElementById("model");
const camera = document.getElementById("camera");
const resetBtn = document.getElementById("reset");

// 初期状態
const initialState = {
  position: new THREE.Vector3(0, 0, -12),
  rotationY: 0,
  scale: 0.5
};

// モデル読み込み後の縦伸び修正
model.addEventListener('model-loaded', () => {
  const mesh = model.getObject3D('mesh');
  if (mesh) mesh.scale.set(1, 1, 1);
  model.object3D.scale.set(initialState.scale, initialState.scale, initialState.scale);
});

// リセットボタン
resetBtn.onclick = () => {
  model.object3D.position.copy(initialState.position);
  model.object3D.rotation.set(0, initialState.rotationY, 0);
  model.object3D.scale.set(initialState.scale, initialState.scale, initialState.scale);
};

// 1本指でXZ移動
let moving = false, lastTouch = null;
document.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    moving = true;
    lastTouch = {x: e.touches[0].clientX, y: e.touches[0].clientY};
  }
});
document.addEventListener("touchmove", e => {
  if (moving && e.touches.length === 1) {
    const dx = (e.touches[0].clientX - lastTouch.x) / 150;
    const dz = (e.touches[0].clientY - lastTouch.y) / 150;
    const move = new THREE.Vector3(-dx, 0, -dz).applyQuaternion(camera.object3D.quaternion);
    model.object3D.position.add(move);
    lastTouch = {x: e.touches[0].clientX, y: e.touches[0].clientY};
  }
});
document.addEventListener("touchend", () => moving = false);

// 2本指で拡大縮小＋回転
let twoFinger = {initialDistance: null, startScale: 0.5, startRot: 0, startMidX: 0};
document.addEventListener("touchstart", e => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    twoFinger.initialDistance = Math.hypot(dx, dy);
    twoFinger.startScale = model.object3D.scale.x;
    twoFinger.startRot = model.object3D.rotation.y;
    twoFinger.startMidX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
  }
});
document.addEventListener("touchmove", e => {
  if (e.touches.length === 2 && twoFinger.initialDistance) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const distance = Math.hypot(dx, dy);
    const newScale = Math.min(Math.max(twoFinger.startScale * (distance / twoFinger.initialDistance), 0.1), 3);
    model.object3D.scale.set(newScale, newScale, newScale);
    const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
    model.object3D.rotation.y = twoFinger.startRot + (midX - twoFinger.startMidX) * 0.01;
  }
});
document.addEventListener("touchend", e => {
  if (e.touches.length < 2) twoFinger.initialDistance = null;
});

// --- iPhone Safari向けズレ＆黒画面対策 ---
function fixARVideo() {
  const video = document.querySelector('video');
  if (video) {
    video.style.position = 'fixed';
    video.style.top = '0';
    video.style.left = '0';
    video.style.width = '100vw';
    video.style.height = '100vh';
    video.style.objectFit = 'cover';
    video.style.zIndex = '-1';
  }
}
window.addEventListener('resize', fixARVideo);
window.addEventListener('load', fixARVideo);
setTimeout(fixARVideo, 1000); // Safari初期化遅延対応
</script>

</body>
</html>
