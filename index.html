<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>AR PLAY - 大代地区公民館</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar-nft.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: #000; }
      #captureButton {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(255, 255, 255, 0.8);
        border: 2px solid #333;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 18px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;">
      
      <!-- 大代地区公民館の位置に画像を表示（1m先） -->
      <a-image
        id="arImage"
        src="https://raw.githubusercontent.com/kushidaplayer4-code/AR-PLAY/main/tower.png"
        gps-entity-place="latitude: 38.29667; longitude: 141.01084;"
        scale="1 1 1"
        position="0 0 -1">
      </a-image>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <!-- 撮影ボタン -->
    <button id="captureButton">📸 撮影して保存</button>

    <script>
      // === 撮影機能 ===
      const button = document.getElementById('captureButton');
      button.addEventListener('click', () => {
        const scene = document.querySelector('a-scene').components.screenshot;
        if (!scene) {
          alert('撮影機能がまだ準備できていません。');
          return;
        }

        const dataUrl = document
          .querySelector('a-scene')
          .components.screenshot
          .getCanvas('perspective')
          .toDataURL('image/png');

        const link = document.createElement('a');
        link.download = 'AR_capture.png';
        link.href = dataUrl;
        link.click();
      });

      // === ピンチイン・ピンチアウト機能 ===
      const image = document.getElementById('arImage');
      let initialDistance = null;
      let currentScale = 1;

      document.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialDistance = Math.sqrt(dx * dx + dy * dy);
        }
      });

      document.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2 && initialDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleFactor = distance / initialDistance;
          const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.3), 3); // 0.3〜3倍の範囲
          image.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
        }
      });

      document.addEventListener('touchend', (e) => {
        if (e.touches.length < 2 && initialDistance) {
          const scaleAttr = image.getAttribute('scale');
          currentScale = parseFloat(scaleAttr.x);
          initialDistance = null;
        }
      });
    </script>
  </body>
</html>
