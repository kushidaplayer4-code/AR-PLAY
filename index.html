<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY デモ（猫モデル安定版）</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info { 
    position:absolute; top:10px; left:10px;
    color:white; font-family:sans-serif;
    background:rgba(0,0,0,0.5);
    padding:8px 12px; border-radius:8px; z-index:999;
  }
</style>
</head>
<body>
<div id="info">1本指で移動、2本指で拡大縮小できます</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  renderer="antialias: true; logarithmicDepthBuffer: true;"
>
  <!-- 光の安定化 -->
  <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
  <a-light type="directional" position="0 1 1" intensity="0.6"></a-light>

  <!-- 猫モデル -->
  <a-entity id="model"
            gltf-model="./gyu.glb"
            position="0 -0.5 -3"
            scale="0.3 0.3 0.3"
            rotation="0 0 0"
            arjs-anchor="enabled: false"
            smooth-move>
  </a-entity>

  <a-camera near="0.01" far="1000"></a-camera>
</a-scene>

<script>
const model = document.getElementById("model");
const info = document.getElementById("info");

model.addEventListener("model-loaded", () => {
  info.textContent = "1本指で移動、2本指で拡大縮小できます";
});

// === 補間用コンポーネント ===
AFRAME.registerComponent('smooth-move', {
  schema: { speed: { type: 'number', default: 0.1 } },
  tick: function () {
    const pos = this.el.getAttribute('position');
    this.el.setAttribute('position', {
      x: pos.x + (currentPos.x - pos.x) * this.data.speed,
      y: pos.y + (currentPos.y - pos.y) * this.data.speed,
      z: pos.z + (currentPos.z - pos.z) * this.data.speed
    });
  }
});

// === ピンチズーム ===
let initialDistance = null;
let currentScale = 0.3;

document.addEventListener("touchstart", e => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    initialDistance = Math.hypot(dx, dy);
  }
});

document.addEventListener("touchmove", e => {
  if (e.touches.length === 2 && initialDistance) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const scaleFactor = Math.hypot(dx, dy) / initialDistance;
    const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.1), 2);
    model.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
  }
});

document.addEventListener("touchend", e => {
  if (e.touches.length < 2 && initialDistance) {
    currentScale = parseFloat(model.getAttribute("scale").x);
    initialDistance = null;
  }
});

// === 1本指スワイプで移動 ===
let startX = null, startY = null;
let currentPos = { x: 0, y: -0.5, z: -3 };

document.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

document.addEventListener("touchmove", e => {
  if (e.touches.length === 1 && startX !== null) {
    const deltaX = e.touches[0].clientX - startX;
    const deltaY = e.touches[0].clientY - startY;
    const moveX = Math.max(Math.min(currentPos.x + deltaX * 0.002, 2), -2);
    const moveY = Math.max(Math.min(currentPos.y - deltaY * 0.002, 2), -2);
    // 直接設定せず currentPos を更新し、補間コンポーネントに任せる
    currentPos.x = moveX;
    currentPos.y = moveY;
  }
});

document.addEventListener("touchend", e => {
  if (startX !== null) {
    startX = null;
    startY = null;
  }
});
</script>
</body>
</html>

