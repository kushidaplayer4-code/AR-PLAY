<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>観光地ARデモ（スマホ対応）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body { margin:0; overflow:hidden; background:#000; font-family:sans-serif; }
      #info {
        position:absolute;
        top:10px; left:10px;
        color:white;
        background:rgba(0,0,0,0.5);
        padding:8px 12px;
        border-radius:8px;
        z-index:999;
      }
      #toggle, #start {
        position:absolute;
        bottom:10px; left:10px;
        z-index:1000;
        padding:10px 16px;
        font-size:16px;
        background:#007bff;
        color:white;
        border:none;
        border-radius:8px;
        cursor:pointer;
      }
      #toggle { left: 160px; background:#28a745; }
    </style>
  </head>

  <body>
    <div id="info">AR準備中...</div>
    <button id="start">AR開始</button>
    <button id="toggle">テストモード</button>

    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
      id="scene"
      style="display:none;"
    >
     <a-image id="model" visible="false"
      src="https://raw.githubusercontent.com/kushidaplayer4-code/AR-PLAY/main/tower.png"
      position="0 1 -2"
      width="2" height="2">
    </a-image>
    <a-camera gps-camera rotation-reader></a-camera>
   </a-scene>

    <script>
      const TARGETS = [
        { name: "東京タワー", lat: 35.6586, lon: 139.7454, message: "ようこそ東京タワーへ！" },
        { name: "清水寺", lat: 34.9949, lon: 135.7850, message: "清水の舞台へようこそ！" }
      ];
      const RANGE = 100;
      let testMode = true;
      const info = document.getElementById("info");
      const model = document.getElementById("model");
      const toggleBtn = document.getElementById("toggle");
      const startBtn = document.getElementById("start");
      const scene = document.getElementById("scene");

      function distance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Δφ/2)**2 +
                  Math.cos(φ1)*Math.cos(φ2) * Math.sin(Δλ/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      function checkLocation(pos) {
        const { latitude, longitude } = pos.coords;
        info.textContent = `現在地: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

        for (const t of TARGETS) {
          const dist = distance(latitude, longitude, t.lat, t.lon);
          if (dist < RANGE) {
            model.setAttribute("visible", "true");
            info.textContent = `${t.message}（${t.name}・距離${dist.toFixed(1)}m）`;
            return;
          }
        }
        model.setAttribute("visible", "false");
        info.textContent += "（観光地付近ではありません）";
      }

      function startTracking() {
        if (testMode) {
          const fakePos = { coords: { latitude: 35.6585, longitude: 139.7453 }};
          checkLocation(fakePos);
        } else {
          if (navigator.geolocation) {
            navigator.geolocation.watchPosition(checkLocation, err => {
              info.textContent = "位置情報が取得できませんでした。";
            }, { enableHighAccuracy: true });
          } else {
            info.textContent = "この端末では位置情報が使えません。";
          }
        }
      }

      toggleBtn.addEventListener("click", () => {
        testMode = !testMode;
        toggleBtn.textContent = testMode ? "テストモード中" : "実際の位置情報モード中";
        model.setAttribute("visible", "false");
        startTracking();
      });

      startBtn.addEventListener("click", () => {
        scene.style.display = "block";
        startBtn.style.display = "none";
        info.textContent = "カメラと位置情報を許可してください。";
        startTracking();
      });
    </script>
  </body>
</html>
