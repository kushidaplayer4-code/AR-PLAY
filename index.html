<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>AR PLAY - å¤§ä»£åœ°åŒºå…¬æ°‘é¤¨ï¼ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä»˜ãï¼‰</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar-nft.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: #000; }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 12px;
        border-radius: 8px;
        font-family: sans-serif;
      }
      #captureButton, #toggle {
        position: absolute;
        bottom: 30px;
        background-color: rgba(255, 255, 255, 0.85);
        border: 2px solid #333;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      #captureButton { left: 50%; transform: translateX(-50%); }
      #toggle { left: 10px; bottom: 80px; }
    </style>
  </head>

  <body>
    <div id="info">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
    <button id="toggle">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <button id="captureButton">ğŸ“¸ æ’®å½±ã—ã¦ä¿å­˜</button>

    <a-scene embedded vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-image
        id="arImage"
        src="https://raw.githubusercontent.com/kushidaplayer4-code/AR-PLAY/main/tower.png"
        scale="1 1 1"
        position="0 0 -1"
        visible="false">
      </a-image>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const TARGET = {
        name: "å¤§ä»£åœ°åŒºå…¬æ°‘é¤¨ï¼ˆå®®åŸçœŒå¤šè³€åŸå¸‚ï¼‰",
        lat: 38.29667,
        lon: 141.01084,
        message: "ã‚ˆã†ã“ãï¼å¤§ä»£åœ°åŒºå…¬æ°‘é¤¨ARä½“é¨“ã¸ï¼"
      };

      const RANGE = 100; // ãƒ¡ãƒ¼ãƒˆãƒ«ä»¥å†…ã§å‡ºç¾
      let testMode = true; // åˆæœŸã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ON

      const info = document.getElementById("info");
      const image = document.getElementById("arImage");
      const toggleBtn = document.getElementById("toggle");

      // è·é›¢è¨ˆç®—
      function distance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI / 180;
        const Ï†2 = lat2 * Math.PI / 180;
        const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
        const Î”Î» = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Î”Ï† / 2) ** 2 +
          Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      // ä½ç½®ç¢ºèª
      function checkLocation(pos) {
        const { latitude, longitude } = pos.coords;
        info.textContent = `ç¾åœ¨åœ°: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

        const dist = distance(latitude, longitude, TARGET.lat, TARGET.lon);
        if (dist < RANGE) {
          image.setAttribute("visible", "true");
          info.textContent = `${TARGET.message}ï¼ˆè·é›¢${dist.toFixed(1)}mï¼‰`;
        } else {
          image.setAttribute("visible", "false");
          info.textContent += "ï¼ˆå…¬æ°‘é¤¨ä»˜è¿‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰";
        }
      }

      // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
      function startTracking() {
        if (testMode) {
          const fakePos = { coords: { latitude: TARGET.lat, longitude: TARGET.lon } };
          checkLocation(fakePos);
        } else {
          navigator.geolocation.watchPosition(checkLocation, err => {
            info.textContent = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
          });
        }
      }

      // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
      toggleBtn.addEventListener("click", () => {
        testMode = !testMode;
        toggleBtn.textContent = testMode
          ? "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ˆåˆ‡æ›¿ï¼‰"
          : "å®Ÿéš›ã®ä½ç½®æƒ…å ±ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ˆåˆ‡æ›¿ï¼‰";
        image.setAttribute("visible", "false");
        startTracking();
      });

      // === æ’®å½±æ©Ÿèƒ½ ===
      const captureBtn = document.getElementById("captureButton");
      captureBtn.addEventListener("click", () => {
        const scene = document.querySelector("a-scene").components.screenshot;
        if (!scene) {
          alert("æ’®å½±æ©Ÿèƒ½ãŒæº–å‚™ã§ãã¦ã„ã¾ã›ã‚“ã€‚");
          return;
        }
        const dataUrl = document
          .querySelector("a-scene")
          .components.screenshot
          .getCanvas("perspective")
          .toDataURL("image/png");

        const link = document.createElement("a");
        link.download = "AR_capture.png";
        link.href = dataUrl;
        link.click();
      });

      // === ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆ ===
      let initialDistance = null;
      let currentScale = 1;

      document.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialDistance = Math.sqrt(dx * dx + dy * dy);
        }
      });

      document.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2 && initialDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleFactor = distance / initialDistance;
          const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.3), 3);
          image.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
        }
      });

      document.addEventListener("touchend", (e) => {
        if (e.touches.length < 2 && initialDistance) {
          const scaleAttr = image.getAttribute("scale");
          currentScale = parseFloat(scaleAttr.x);
          initialDistance = null;
        }
      });

      // èµ·å‹•
      startTracking();
    </script>
  </body>
</html>
