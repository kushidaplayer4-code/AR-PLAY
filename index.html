<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY デモ</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info { position:absolute; top:10px; left:10px; color:white; font-family:sans-serif; background:rgba(0,0,0,0.5); padding:8px 12px; border-radius:8px; z-index:999; }
  button { position:absolute; bottom:10px; padding:8px 14px; border:none; border-radius:8px; font-size:16px; color:white; cursor:pointer; z-index:1000; }
  #toggle { left:10px; background:#007bff; }
  #capture { right:10px; background:#28a745; }
</style>
</head>
<body>
<div id="info">現在地を取得中...</div>
<button id="toggle">テストモード中（切替）</button>
<button id="capture">📸 撮影</button>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="preserveDrawingBuffer: true;">
  <a-image id="markerImage" visible="false" src="./tower.png" position="0 0 -1" scale="1 1 1"></a-image>
  <a-camera></a-camera>
</a-scene>

<script>
const TARGET = { name:"大代地区公民館", lat:38.29667, lon:141.01084, message:"大代地区公民館にようこそ！" };
const RANGE = 100;
let testMode = true;
const info = document.getElementById("info");
const img = document.getElementById("markerImage");
const toggleBtn = document.getElementById("toggle");
const captureBtn = document.getElementById("capture");

function distance(lat1, lon1, lat2, lon2){
  const R=6371e3, φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180, Δφ=(lat2-lat1)*Math.PI/180, Δλ=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function checkLocation(pos){
  const { latitude, longitude } = pos.coords;
  const dist = distance(latitude, longitude, TARGET.lat, TARGET.lon);
  info.textContent = `現在地: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
  if(dist<RANGE){ img.setAttribute("visible","true"); info.textContent = `${TARGET.message}（距離${dist.toFixed(1)}m）`; }
  else img.setAttribute("visible","false");
}

function startTracking(){
  if(testMode) checkLocation({ coords:{ latitude:TARGET.lat, longitude:TARGET.lon } });
  else if(navigator.geolocation) navigator.geolocation.watchPosition(checkLocation, ()=>info.textContent="位置情報が取得できません");
  else info.textContent="位置情報がサポートされていません";
}

// === ボタン操作 ===
toggleBtn.onclick = ()=>{
  testMode = !testMode;
  toggleBtn.textContent = testMode?"テストモード中（切替）":"実際の位置情報モード中（切替）";
  img.setAttribute("visible","false");
  startTracking();
};

captureBtn.onclick = async ()=>{
  info.textContent="撮影中...";
  try{
    const canvas = await html2canvas(document.body);
    const dataUrl = canvas.toDataURL("image/png");
    const a=document.createElement("a");
    a.href=dataUrl; a.download="AR_capture.png"; a.click();
    info.textContent="撮影完了！長押しで保存してください";
  }catch(e){ info.textContent="撮影に失敗しました"; console.error(e); }
};

// === ピンチ操作 ===
let initialDistance=null, currentScale=1;
document.addEventListener("touchstart", e=>{ if(e.touches.length===2){ const dx=e.touches[0].clientX-e.touches[1].clientX, dy=e.touches[0].clientY-e.touches[1].clientY; initialDistance=Math.hypot(dx,dy); } });
document.addEventListener("touchmove", e=>{
  if(e.touches.length===2 && initialDistance){
    const dx=e.touches[0].clientX-e.touches[1].clientX, dy=e.touches[0].clientY-e.touches[1].clientY;
    const scaleFactor=Math.hypot(dx,dy)/initialDistance;
    const newScale=Math.min(Math.max(currentScale*scaleFactor,0.3),3);
    img.setAttribute("scale",`${newScale} ${newScale} ${newScale}`);
  }
});
document.addEventListener("touchend", e=>{
  if(e.touches.length<2 && initialDistance){ currentScale=parseFloat(img.getAttribute("scale").x); initialDistance=null; }
});

// 起動
startTracking();
</script>
</body>
</html>

