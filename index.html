<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY デモ（3Dモデル固定切り替え）</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info, #lockBtn { 
    position:absolute; 
    left:10px;
    color:white; font-family:sans-serif;
    background:rgba(0,0,0,0.5);
    padding:8px 12px; border-radius:8px; z-index:999;
  }
  #info { top:10px; }
  #lockBtn { bottom:10px; }
</style>
</head>
<body>
<div id="info">1本指で移動、2本指で拡大縮小できます</div>
<button id="lockBtn">動かないで！</button>

<!-- ===== AR SCENE ===== -->
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <!-- モデルを marker の子として配置 -->
  <a-marker id="marker" type="pattern" url="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/data/data/patt.hiro">
    <a-entity id="model"
              gltf-model="./gyu.glb"
              position="0 0 0"
              scale="0.2 0.2 0.2"
              rotation="0 0 0">
    </a-entity>
  </a-marker>
  <a-entity camera></a-entity>
</a-scene>

<script>
const model = document.getElementById("model");
const marker = document.getElementById("marker");
const info = document.getElementById("info");
const lockBtn = document.getElementById("lockBtn");

let locked = false; // 固定状態フラグ
let currentScale = 0.5;
let initialDistance = null;

// === モデル読み込み後 ===
model.addEventListener("model-loaded", () => {
  info.textContent = "1本指で移動、2本指で拡大縮小できます";
});

// === ピンチズーム ===
document.addEventListener("touchstart", e => {
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    initialDistance = Math.hypot(dx, dy);
  }
});

document.addEventListener("touchmove", e => {
  if (e.touches.length === 2 && initialDistance && !locked) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const scaleFactor = Math.hypot(dx, dy) / initialDistance;
    const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.1), 2);
    model.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
  }
});

document.addEventListener("touchend", e => {
  if (e.touches.length < 2 && initialDistance) {
    currentScale = parseFloat(model.getAttribute("scale").x);
    initialDistance = null;
  }
});

// === 1本指スワイプで移動 ===
let startX = null, startY = null;
let currentPos = { x: 0, y: 0, z: 0 };

document.addEventListener("touchstart", e => {
  if (e.touches.length === 1) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

document.addEventListener("touchmove", e => {
  if (e.touches.length === 1 && startX !== null && !locked) {
    const deltaX = e.touches[0].clientX - startX;
    const deltaY = e.touches[0].clientY - startY;
    const moveX = currentPos.x + deltaX * 0.002;
    const moveY = currentPos.y - deltaY * 0.002;
    model.setAttribute("position", `${moveX} ${moveY} ${currentPos.z}`);
  }
});

document.addEventListener("touchend", e => {
  if (startX !== null) {
    const pos = model.getAttribute("position");
    currentPos = { x: pos.x, y: pos.y, z: pos.z };
    startX = null;
    startY = null;
  }
});

// === 「動かないで！」ボタン ===
lockBtn.addEventListener("click", () => {
  if (!locked) {
    // モデルのワールド座標を取得
    const worldPos = model.object3D.getWorldPosition(new THREE.Vector3());
    const worldRot = model.object3D.getWorldQuaternion(new THREE.Quaternion());

    // marker から外して scene に直接追加
    const scene = document.querySelector("a-scene");
    marker.remove(model);
    scene.appendChild(model);

    // ワールド座標を反映（固定）
    model.object3D.position.copy(worldPos);
    model.object3D.quaternion.copy(worldRot);

    locked = true;
    lockBtn.textContent = "固定解除";
    info.textContent = "モデルが固定されました（動かないで！）";
  } else {
    // 元に戻す
    marker.appendChild(model);
    model.setAttribute("position", "0 0 0");
    model.setAttribute("rotation", "0 0 0");
    locked = false;
    lockBtn.textContent = "動かないで！";
    info.textContent = "再びマーカー追従モードになりました";
  }
});
</script>
</body>
</html>
