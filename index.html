<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY ãƒ‡ãƒ¢ï¼ˆ3Dãƒ¢ãƒ‡ãƒ«ç§»å‹•ãƒ»æ‹¡å¤§ï¼‹æ’®å½±ï¼†éŒ²ç”»ï¼‰</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info {
    position:absolute; top:10px; left:10px;
    color:white; font-family:sans-serif;
    background:rgba(0,0,0,0.5);
    padding:8px 12px; border-radius:8px; z-index:999;
  }
  button {
    position:absolute; bottom:20px; padding:10px 16px;
    border:none; border-radius:10px; color:white;
    font-size:18px; cursor:pointer; z-index:1000;
  }
  #capture { right:20px; background:#28a745; }
  #record { left:20px; background:#dc3545; }
</style>
</head>
<body>
<div id="info">1æœ¬æŒ‡ã§ç§»å‹•ã€2æœ¬æŒ‡ã§æ‹¡å¤§ç¸®å°ã€ğŸ“¸ã§æ’®å½±ã€ğŸ¥ã§éŒ²ç”»</div>
<button id="capture">ğŸ“¸ æ’®å½±</button>
<button id="record">ğŸ¥ éŒ²ç”»é–‹å§‹</button>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="preserveDrawingBuffer: true;">
  <a-entity id="model"
            gltf-model="./gyu.glb"
            position="0 0 -5"
            scale="0.2 0.2 0.2"
            rotation="0 0 0"></a-entity>
  <a-camera></a-camera>
</a-scene>

<script>
const model = document.getElementById("model");
const info = document.getElementById("info");
const captureBtn = document.getElementById("capture");
const recordBtn = document.getElementById("record");

let startX=null, startY=null;
let currentPos={x:0,y:0,z:-5};
let initialDistance=null;
let currentScale=0.2;

// ===== é™æ­¢ç”»æ’®å½± =====
captureBtn.onclick = () => {
  const sceneEl = document.querySelector("a-scene");
  const canvas = sceneEl.renderer.domElement;
  try {
    const dataUrl = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = "AR_capture.png";
    a.click();
    info.textContent = "ğŸ“¸ æ’®å½±å®Œäº†ï¼é•·æŠ¼ã—ã§ä¿å­˜ã—ã¦ãã ã•ã„ï¼ˆiPhoneã®å ´åˆï¼‰";
  } catch (e) {
    console.error(e);
    info.textContent = "æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
};

// ===== å‹•ç”»éŒ²ç”» =====
let recorder, chunks = [], recording = false;

recordBtn.onclick = () => {
  const sceneEl = document.querySelector("a-scene");
  const canvas = sceneEl.renderer.domElement;

  if (!recording) {
    const stream = canvas.captureStream(30); // 30fpséŒ²ç”»
    recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "AR_recording.webm";
      a.click();
      chunks = [];
      info.textContent = "ğŸ¥ éŒ²ç”»å®Œäº†ï¼";
    };
    recorder.start();
    recording = true;
    recordBtn.textContent = "â–  éŒ²ç”»åœæ­¢";
    info.textContent = "ğŸ¬ éŒ²ç”»ä¸­...";
  } else {
    recorder.stop();
    recording = false;
    recordBtn.textContent = "ğŸ¥ éŒ²ç”»é–‹å§‹";
  }
};

// ===== ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ  =====
document.addEventListener("touchstart", e=>{
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    initialDistance=Math.hypot(dx,dy);
  }else if(e.touches.length===1){
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
  }
});

document.addEventListener("touchmove", e=>{
  if(e.touches.length===2 && initialDistance){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const scaleFactor=Math.hypot(dx,dy)/initialDistance;
    const newScale=Math.min(Math.max(currentScale*scaleFactor,0.05),3);
    model.setAttribute("scale",`${newScale} ${newScale} ${newScale}`);
  }
  if(e.touches.length===1 && startX!==null){
    const deltaX=e.touches[0].clientX-startX;
    const deltaY=e.touches[0].clientY-startY;
    const moveX=currentPos.x+deltaX*0.002;
    const moveY=currentPos.y-deltaY*0.002;
    model.setAttribute("position",`${moveX} ${moveY} ${currentPos.z}`);
  }
});

document.addEventListener("touchend", e=>{
  if(e.touches.length<2 && initialDistance){
    currentScale=parseFloat(model.getAttribute("scale").x);
    initialDistance=null;
  }
  if(startX!==null){
    const pos=model.getAttribute("position");
    currentPos={x:pos.x,y:pos.y,z:pos.z};
    startX=null;
    startY=null;
  }
});
</script>
</body>
</html>
