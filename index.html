<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY デモ（3Dモデル移動＆拡大・改善版）</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info { 
    position:absolute; top:10px; left:10px;
    color:white; font-family:sans-serif;
    background:rgba(0,0,0,0.5);
    padding:8px 12px; border-radius:8px; z-index:999;
  }
</style>
</head>
<body>
<div id="info">1本指で移動、2本指で拡大縮小できます</div>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; smooth: true; trackingMethod: best;">
  <a-entity id="model"
            gltf-model="./gyu.glb"
            position="0 0 -3"
            scale="0.2 0.2 0.2"
            rotation="0 0 0">
  </a-entity>
  <a-camera near="0.2" far="1000"></a-camera>
</a-scene>

<script>
const model = document.getElementById("model");
const info = document.getElementById("info");

model.addEventListener("model-loaded", () => {
  info.textContent = "1本指で移動、2本指で拡大縮小できます";
});

// ===== 補間用関数 =====
function lerp(a,b,t){return a+(b-a)*t;}

let targetPos = { x:0, y:0, z:-3 };
let currentPos = { x:0, y:0, z:-3 };
let targetScale = 0.2;
let currentScale = 0.2;

// ===== ピンチズーム =====
let initialDistance = null;

document.addEventListener("touchstart", e => {
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    initialDistance=Math.hypot(dx,dy);
  } else if(e.touches.length===1){
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

document.addEventListener("touchmove", e => {
  if(e.touches.length===2 && initialDistance){
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const scaleFactor = Math.hypot(dx,dy)/initialDistance;
    targetScale = Math.min(Math.max(currentScale*scaleFactor,0.1),2);
  } else if(e.touches.length===1 && startX!==null){
    const deltaX = e.touches[0].clientX-startX;
    const deltaY = e.touches[0].clientY-startY;
    targetPos.x = currentPos.x + deltaX*0.002;
    targetPos.y = currentPos.y - deltaY*0.002;
  }
});

document.addEventListener("touchend", e => {
  if(e.touches.length<2 && initialDistance){
    currentScale = targetScale;
    initialDistance = null;
  }
  if(e.touches.length===0){
    currentPos = {...targetPos};
    startX = null; startY = null;
  }
});

// ===== A-Frameコンポーネントで補間 =====
AFRAME.registerComponent('smooth-update',{
  tick:function(){
    const pos = model.getAttribute("position");
    const scale = model.getAttribute("scale").x;

    const newX = lerp(pos.x,targetPos.x,0.1);
    const newY = lerp(pos.y,targetPos.y,0.1);
    const newScale = lerp(scale,targetScale,0.1);

    model.setAttribute("position",`${newX} ${newY} ${pos.z}`);
    model.setAttribute("scale",`${newScale} ${newScale} ${newScale}`);
  }
});
model.setAttribute("smooth-update","");
</script>
</body>
</html>
