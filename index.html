<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>AR PLAY - 大代地区公民館（テストモード付き）</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.3.2/aframe/build/aframe-ar-nft.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: #000; }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px 12px;
        border-radius: 8px;
        font-family: sans-serif;
      }
      #captureButton, #toggle {
        position: absolute;
        bottom: 30px;
        background-color: rgba(255, 255, 255, 0.85);
        border: 2px solid #333;
        padding: 10px 20px;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
      }
      #captureButton { left: 50%; transform: translateX(-50%); }
      #toggle { left: 10px; bottom: 80px; }
    </style>
  </head>

  <body>
    <div id="info">現在地を取得中...</div>
    <button id="toggle">テストモード切替</button>
    <button id="captureButton">📸 撮影して保存</button>

    <a-scene embedded vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-image
        id="arImage"
        src="https://raw.githubusercontent.com/kushidaplayer4-code/AR-PLAY/main/tower.png"
        scale="1 1 1"
        position="0 0 -1"
        visible="false">
      </a-image>

      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      const TARGET = {
        name: "大代地区公民館（宮城県多賀城市）",
        lat: 38.29667,
        lon: 141.01084,
        message: "ようこそ！大代地区公民館AR体験へ！"
      };

      const RANGE = 100; // メートル以内で出現
      let testMode = true; // 初期はテストモードON

      const info = document.getElementById("info");
      const image = document.getElementById("arImage");
      const toggleBtn = document.getElementById("toggle");

      // 距離計算
      function distance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ / 2) ** 2 +
          Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      // 位置確認
      function checkLocation(pos) {
        const { latitude, longitude } = pos.coords;
        info.textContent = `現在地: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

        const dist = distance(latitude, longitude, TARGET.lat, TARGET.lon);
        if (dist < RANGE) {
          image.setAttribute("visible", "true");
          info.textContent = `${TARGET.message}（距離${dist.toFixed(1)}m）`;
        } else {
          image.setAttribute("visible", "false");
          info.textContent += "（公民館付近ではありません）";
        }
      }

      // テストモード
      function startTracking() {
        if (testMode) {
          const fakePos = { coords: { latitude: TARGET.lat, longitude: TARGET.lon } };
          checkLocation(fakePos);
        } else {
          navigator.geolocation.watchPosition(checkLocation, err => {
            info.textContent = "位置情報が取得できませんでした。";
          });
        }
      }

      // テストモード切替
      toggleBtn.addEventListener("click", () => {
        testMode = !testMode;
        toggleBtn.textContent = testMode
          ? "テストモード中（切替）"
          : "実際の位置情報モード中（切替）";
        image.setAttribute("visible", "false");
        startTracking();
      });

      // === 撮影機能 ===
      const captureBtn = document.getElementById("captureButton");
      captureBtn.addEventListener("click", () => {
        const scene = document.querySelector("a-scene").components.screenshot;
        if (!scene) {
          alert("撮影機能が準備できていません。");
          return;
        }
        const dataUrl = document
          .querySelector("a-scene")
          .components.screenshot
          .getCanvas("perspective")
          .toDataURL("image/png");

        const link = document.createElement("a");
        link.download = "AR_capture.png";
        link.href = dataUrl;
        link.click();
      });

      // === ピンチイン・アウト ===
      let initialDistance = null;
      let currentScale = 1;

      document.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialDistance = Math.sqrt(dx * dx + dy * dy);
        }
      });

      document.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2 && initialDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleFactor = distance / initialDistance;
          const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.3), 3);
          image.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
        }
      });

      document.addEventListener("touchend", (e) => {
        if (e.touches.length < 2 && initialDistance) {
          const scaleAttr = image.getAttribute("scale");
          currentScale = parseFloat(scaleAttr.x);
          initialDistance = null;
        }
      });

      // 起動
      startTracking();
    </script>
  </body>
</html>
