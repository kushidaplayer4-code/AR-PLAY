<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY デモ（フリーズ確実版）</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info {
    position:absolute; top:10px; left:10px;
    color:white; font-family:sans-serif;
    background:rgba(0,0,0,0.5);
    padding:8px 12px; border-radius:8px; z-index:999;
  }
  #freezeBtn {
    position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
    padding:10px 20px; font-size:18px;
    background:#ff4081; color:white; border:none;
    border-radius:12px; cursor:pointer;
    box-shadow:0 0 10px rgba(0,0,0,0.3);
  }
  #freezeBtn.frozen { background:#4caf50; }
</style>
</head>
<body>
<div id="info">1本指で移動、2本指で拡大縮小できます</div>
<button id="freezeBtn">動かないで！</button>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
  <!-- 通常のトラッキングモデル -->
  <a-entity id="model"
            gltf-model="./gyu.glb"
            position="0 0 -3"
            scale="0.5 0.5 0.5"
            rotation="0 0 0">
  </a-entity>

  <!-- 固定用モデル（最初は非表示） -->
  <a-entity id="frozenModel" visible="false"></a-entity>

  <a-camera></a-camera>
</a-scene>

<script>
const model = document.getElementById("model");
const frozenModel = document.getElementById("frozenModel");
const freezeBtn = document.getElementById("freezeBtn");

let frozen = false;
let currentScale = 0.5;
let currentPos = { x: 0, y: 0, z: -3 };

// ===== モデルロード完了後 =====
model.addEventListener("model-loaded", () => {
  model.object3D.traverse(obj => {
    if (obj.isMesh) {
      obj.renderOrder = 1;
      obj.material.depthTest = true;
    }
  });
});

// ===== フリーズボタン =====
freezeBtn.addEventListener("click", () => {
  if (!frozen) {
    // 現在の位置・回転・スケールを取得
    const pos = model.getAttribute("position");
    const rot = model.getAttribute("rotation");
    const scl = model.getAttribute("scale");

    // 固定用エンティティに同じモデルをセット
    frozenModel.setAttribute("gltf-model", "./gyu.glb");
    frozenModel.setAttribute("position", `${pos.x} ${pos.y} ${pos.z}`);
    frozenModel.setAttribute("rotation", `${rot.x} ${rot.y} ${rot.z}`);
    frozenModel.setAttribute("scale", `${scl.x} ${scl.y} ${scl.z}`);

    // 表示切り替え
    frozenModel.setAttribute("visible", "true");
    model.setAttribute("visible", "false");

    freezeBtn.textContent = "動いていいよ";
    freezeBtn.classList.add("frozen");
    frozen = true;
  } else {
    // 元に戻す
    frozenModel.setAttribute("visible", "false");
    model.setAttribute("visible", "true");

    freezeBtn.textContent = "動かないで！";
    freezeBtn.classList.remove("frozen");
    frozen = false;
  }
});

// ===== ジェスチャー操作 =====
let initialDistance = null;
let startX = null, startY = null;

document.addEventListener("touchstart", e => {
  if (frozen) return; // 固定中は操作禁止
  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    initialDistance = Math.hypot(dx, dy);
  } else if (e.touches.length === 1) {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
});

document.addEventListener("touchmove", e => {
  if (frozen) return;
  if (e.touches.length === 2 && initialDistance) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const scaleFactor = Math.hypot(dx, dy) / initialDistance;
    const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.1), 2);
    model.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
  } else if (e.touches.length === 1 && startX !== null) {
    const deltaX = e.touches[0].clientX - startX;
    const deltaY = e.touches[0].clientY - startY;
    const moveX = currentPos.x + deltaX * 0.002;
    const moveY = currentPos.y - deltaY * 0.002;
    model.setAttribute("position", `${moveX} ${moveY} ${currentPos.z}`);
  }
});

document.addEventListener("touchend", e => {
  if (frozen) return;
  if (initialDistance && e.touches.length < 2) {
    currentScale = parseFloat(model.getAttribute("scale").x);
    initialDistance = null;
  }
  if (startX !== null) {
    const pos = model.getAttribute("position");
    currentPos = { x: pos.x, y: pos.y, z: pos.z };
    startX = null;
    startY = null;
  }
});
</script>
</body>
</html>
