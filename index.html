<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>AR PLAY（大代地区公民館デモ）</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
    <style>
      body { margin:0; overflow:hidden; background:#000; }
      #info {
        position:absolute;
        top:10px; left:10px;
        color:white;
        font-family:sans-serif;
        background:rgba(0,0,0,0.5);
        padding:8px 12px;
        border-radius:8px;
        z-index:999;
      }
      #toggle, #capture {
        position:absolute;
        bottom:10px;
        z-index:1000;
        padding:8px 14px;
        border:none;
        border-radius:8px;
        font-size:16px;
        color:white;
        cursor:pointer;
      }
      #toggle { left:10px; background:#007bff; }
      #capture { right:10px; background:#28a745; }
    </style>
  </head>

  <body>
    <div id="info">現在地を取得中...</div>
    <button id="toggle">テストモード切替</button>
    <button id="capture">📸 撮影</button>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="preserveDrawingBuffer: true;">
      
      <!-- tower.pngを1m先に表示 -->
      <a-image
        id="markerImage"
        visible="false"
        src="https://raw.githubusercontent.com/kushidaplayer4-code/AR-PLAY/main/tower.png"
        position="0 0 -1"
        scale="1 1 1">
      </a-image>

      <a-camera></a-camera>
    </a-scene>

    <script>
      // === 設定 ===
      const TARGET = { 
        name: "大代地区公民館",
        lat: 38.29667,
        lon: 141.01084,
        message: "大代地区公民館にようこそ！"
      };
      const RANGE = 100; // メートル以内で出現
      let testMode = true; // ← 起動時はテストモードON

      const info = document.getElementById("info");
      const img = document.getElementById("markerImage");
      const toggleBtn = document.getElementById("toggle");
      const captureBtn = document.getElementById("capture");

      // === 距離計算 ===
      function distance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Δφ/2)**2 +
                  Math.cos(φ1)*Math.cos(φ2) * Math.sin(Δλ/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      // === 現在地チェック ===
      function checkLocation(pos) {
        const { latitude, longitude } = pos.coords;
        info.textContent = `現在地: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

        const dist = distance(latitude, longitude, TARGET.lat, TARGET.lon);
        if (dist < RANGE) {
          img.setAttribute("visible", "true");
          info.textContent = `${TARGET.message}（距離${dist.toFixed(1)}m）`;
        } else {
          img.setAttribute("visible", "false");
          info.textContent += "（範囲外）";
        }
      }

      // === 位置情報 or テスト ===
      function startTracking() {
        if (testMode) {
          const fakePos = { coords: { latitude: 38.29667, longitude: 141.01084 }};
          checkLocation(fakePos);
        } else {
          navigator.geolocation.watchPosition(checkLocation, () => {
            info.textContent = "位置情報が取得できませんでした。";
          });
        }
      }

      // === テストモード切替 ===
      toggleBtn.addEventListener("click", () => {
        testMode = !testMode;
        toggleBtn.textContent = testMode ? "テストモード中（切替）" : "実際の位置情報モード中（切替）";
        img.setAttribute("visible", "false");
        startTracking();
      });

      // === 撮影 ===
      captureBtn.addEventListener("click", () => {
        const scene = document.querySelector("a-scene").components.screenshot;
        if (!scene) {
          alert("まだ準備中です");
          return;
        }
        const canvas = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = "AR_capture.png";
        a.click();
      });

      // === ピンチ拡大縮小 ===
      let initialDistance = null;
      let currentScale = 1;
      document.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialDistance = Math.sqrt(dx * dx + dy * dy);
        }
      });
      document.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2 && initialDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleFactor = distance / initialDistance;
          const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.3), 3);
          img.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
        }
      });
      document.addEventListener("touchend", (e) => {
        if (e.touches.length < 2 && initialDistance) {
          const scaleAttr = img.getAttribute("scale");
          currentScale = parseFloat(scaleAttr.x);
          initialDistance = null;
        }
      });

      // === 起動 ===
      startTracking();
    </script>
  </body>
</html>
