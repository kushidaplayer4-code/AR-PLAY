<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>AR PLAYï¼ˆå¤§ä»£åœ°åŒºå…¬æ°‘é¤¨ãƒ‡ãƒ¢ï¼‰</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
    <style>
      body { margin:0; overflow:hidden; background:#000; }
      #info {
        position:absolute;
        top:10px; left:10px;
        color:white;
        font-family:sans-serif;
        background:rgba(0,0,0,0.5);
        padding:8px 12px;
        border-radius:8px;
        z-index:999;
      }
      #toggle, #capture {
        position:absolute;
        bottom:10px;
        z-index:1000;
        padding:8px 14px;
        border:none;
        border-radius:8px;
        font-size:16px;
        color:white;
        cursor:pointer;
      }
      #toggle { left:10px; background:#007bff; }
      #capture { right:10px; background:#28a745; }
    </style>
  </head>

  <body>
    <div id="info">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
    <button id="toggle">ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <button id="capture">ğŸ“¸ æ’®å½±</button>

    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="preserveDrawingBuffer: true;">
      
      <!-- tower.pngã‚’1må…ˆã«è¡¨ç¤º -->
      <a-image
        id="markerImage"
        visible="false"
        src="https://raw.githubusercontent.com/kushidaplayer4-code/AR-PLAY/main/tower.png"
        position="0 0 -1"
        scale="1 1 1">
      </a-image>

      <a-camera></a-camera>
    </a-scene>

    <script>
      // === è¨­å®š ===
      const TARGET = { 
        name: "å¤§ä»£åœ°åŒºå…¬æ°‘é¤¨",
        lat: 38.29667,
        lon: 141.01084,
        message: "å¤§ä»£åœ°åŒºå…¬æ°‘é¤¨ã«ã‚ˆã†ã“ãï¼"
      };
      const RANGE = 100; // ãƒ¡ãƒ¼ãƒˆãƒ«ä»¥å†…ã§å‡ºç¾
      let testMode = true; // â† èµ·å‹•æ™‚ã¯ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ON

      const info = document.getElementById("info");
      const img = document.getElementById("markerImage");
      const toggleBtn = document.getElementById("toggle");
      const captureBtn = document.getElementById("capture");

      // === è·é›¢è¨ˆç®— ===
      function distance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = lat1 * Math.PI/180;
        const Ï†2 = lat2 * Math.PI/180;
        const Î”Ï† = (lat2-lat1) * Math.PI/180;
        const Î”Î» = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(Î”Ï†/2)**2 +
                  Math.cos(Ï†1)*Math.cos(Ï†2) * Math.sin(Î”Î»/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      }

      // === ç¾åœ¨åœ°ãƒã‚§ãƒƒã‚¯ ===
      function checkLocation(pos) {
        const { latitude, longitude } = pos.coords;
        info.textContent = `ç¾åœ¨åœ°: ${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;

        const dist = distance(latitude, longitude, TARGET.lat, TARGET.lon);
        if (dist < RANGE) {
          img.setAttribute("visible", "true");
          info.textContent = `${TARGET.message}ï¼ˆè·é›¢${dist.toFixed(1)}mï¼‰`;
        } else {
          img.setAttribute("visible", "false");
          info.textContent += "ï¼ˆç¯„å›²å¤–ï¼‰";
        }
      }

      // === ä½ç½®æƒ…å ± or ãƒ†ã‚¹ãƒˆ ===
      function startTracking() {
        if (testMode) {
          const fakePos = { coords: { latitude: 38.29667, longitude: 141.01084 }};
          checkLocation(fakePos);
        } else {
          navigator.geolocation.watchPosition(checkLocation, () => {
            info.textContent = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
          });
        }
      }

      // === ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ===
      toggleBtn.addEventListener("click", () => {
        testMode = !testMode;
        toggleBtn.textContent = testMode ? "ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ˆåˆ‡æ›¿ï¼‰" : "å®Ÿéš›ã®ä½ç½®æƒ…å ±ãƒ¢ãƒ¼ãƒ‰ä¸­ï¼ˆåˆ‡æ›¿ï¼‰";
        img.setAttribute("visible", "false");
        startTracking();
      });

      // === æ’®å½± ===
      captureBtn.addEventListener("click", () => {
        const scene = document.querySelector("a-scene").components.screenshot;
        if (!scene) {
          alert("ã¾ã æº–å‚™ä¸­ã§ã™");
          return;
        }
        const canvas = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
        const dataUrl = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = "AR_capture.png";
        a.click();
      });

      // === ãƒ”ãƒ³ãƒæ‹¡å¤§ç¸®å° ===
      let initialDistance = null;
      let currentScale = 1;
      document.addEventListener("touchstart", (e) => {
        if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialDistance = Math.sqrt(dx * dx + dy * dy);
        }
      });
      document.addEventListener("touchmove", (e) => {
        if (e.touches.length === 2 && initialDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const scaleFactor = distance / initialDistance;
          const newScale = Math.min(Math.max(currentScale * scaleFactor, 0.3), 3);
          img.setAttribute("scale", `${newScale} ${newScale} ${newScale}`);
        }
      });
      document.addEventListener("touchend", (e) => {
        if (e.touches.length < 2 && initialDistance) {
          const scaleAttr = img.getAttribute("scale");
          currentScale = parseFloat(scaleAttr.x);
          initialDistance = null;
        }
      });

      // === èµ·å‹• ===
      startTracking();
    </script>
  </body>
</html>
