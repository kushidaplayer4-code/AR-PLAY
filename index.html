<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>AR PLAY デモ（3Dモデル移動・拡大＋撮影＆録画）</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.js"></script>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #info {
    position:absolute; top:10px; left:10px;
    color:white; font-family:sans-serif;
    background:rgba(0,0,0,0.5);
    padding:8px 12px; border-radius:8px; z-index:999;
  }
  button {
    position:absolute; bottom:20px; padding:10px 16px;
    border:none; border-radius:10px; color:white;
    font-size:18px; cursor:pointer; z-index:1000;
  }
  #capture { right:20px; background:#28a745; }
  #record { left:20px; background:#dc3545; }
</style>
</head>
<body>
<div id="info">1本指で移動、2本指で拡大縮小、📸で撮影、🎥で録画</div>
<button id="capture">📸 撮影</button>
<button id="record">🎥 録画開始</button>

<a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" renderer="preserveDrawingBuffer: true;">
  <a-entity id="model"
            gltf-model="./gyu.glb"
            position="0 0 -5"
            scale="0.2 0.2 0.2"
            rotation="0 0 0"></a-entity>
  <a-camera></a-camera>
</a-scene>

<script>
const model = document.getElementById("model");
const info = document.getElementById("info");
const captureBtn = document.getElementById("capture");
const recordBtn = document.getElementById("record");

let startX=null, startY=null;
let currentPos={x:0,y:0,z:-5};
let initialDistance=null;
let currentScale=0.2;

// ===== 静止画撮影 =====
captureBtn.onclick = () => {
  const sceneEl = document.querySelector("a-scene");
  const canvas = sceneEl.renderer.domElement;
  try {
    const dataUrl = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = "AR_capture.png";
    a.click();
    info.textContent = "📸 撮影完了！長押しで保存してください（iPhoneの場合）";
  } catch (e) {
    console.error(e);
    info.textContent = "撮影に失敗しました";
  }
};

// ===== 動画録画 =====
let recorder, chunks = [], recording = false;

recordBtn.onclick = () => {
  const sceneEl = document.querySelector("a-scene");
  const canvas = sceneEl.renderer.domElement;

  if (!recording) {
    const stream = canvas.captureStream(30); // 30fps録画
    recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "AR_recording.webm";
      a.click();
      chunks = [];
      info.textContent = "🎥 録画完了！";
    };
    recorder.start();
    recording = true;
    recordBtn.textContent = "■ 録画停止";
    info.textContent = "🎬 録画中...";
  } else {
    recorder.stop();
    recording = false;
    recordBtn.textContent = "🎥 録画開始";
  }
};

// ===== ピンチズーム =====
document.addEventListener("touchstart", e=>{
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    initialDistance=Math.hypot(dx,dy);
  }else if(e.touches.length===1){
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
  }
});

document.addEventListener("touchmove", e=>{
  if(e.touches.length===2 && initialDistance){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const scaleFactor=Math.hypot(dx,dy)/initialDistance;
    const newScale=Math.min(Math.max(currentScale*scaleFactor,0.05),3);
    model.setAttribute("scale",`${newScale} ${newScale} ${newScale}`);
  }
  if(e.touches.length===1 && startX!==null){
    const deltaX=e.touches[0].clientX-startX;
    const deltaY=e.touches[0].clientY-startY;
    const moveX=currentPos.x+deltaX*0.002;
    const moveY=currentPos.y-deltaY*0.002;
    model.setAttribute("position",`${moveX} ${moveY} ${currentPos.z}`);
  }
});

document.addEventListener("touchend", e=>{
  if(e.touches.length<2 && initialDistance){
    currentScale=parseFloat(model.getAttribute("scale").x);
    initialDistance=null;
  }
  if(startX!==null){
    const pos=model.getAttribute("position");
    currentPos={x:pos.x,y:pos.y,z:pos.z};
    startX=null;
    startY=null;
  }
});
</script>
</body>
</html>
